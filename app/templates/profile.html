{% extends "base.html" %}
{% block title %}Profile • ClearDrop{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
  
  <div class="flex items-start justify-between gap-4 flex-wrap">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Profile</h1>
      <p class="text-slate-500 mt-1">Manage your account and see a quick snapshot of your system.</p>
    </div>

    <div class="flex items-center gap-2">
      <a href="{{ url_for('dash.dashboard') }}"
         class="px-4 py-2 rounded-2xl text-sm font-semibold text-white shadow-soft
                bg-gradient-to-r from-aqua-500 to-lavender-500 hover:opacity-95 transition">
        Go to Dashboard
      </a>
      <a href="{{ url_for('dash.devices') }}"
         class="px-4 py-2 rounded-2xl text-sm font-semibold bg-white/80 border border-slate-200
                hover:bg-white transition shadow-soft">
        Manage Devices
      </a>
    </div>
  </div>

  
  <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">

  
    <div class="rounded-3xl bg-white/75 backdrop-blur border border-white shadow-soft p-6 lg:col-span-1">
      <div class="flex items-center gap-4">
        
        <div class="h-14 w-14 rounded-2xl bg-gradient-to-br from-aqua-200 to-lavender-200 border border-white shadow-soft flex items-center justify-center">
          <span class="text-lg font-bold text-slate-700">
            {{ (user.email[:1] if user.email else "U")|upper }}
          </span>
        </div>

        <div>
          <div class="text-lg font-bold text-slate-900">ClearDrop User</div>
          <div class="text-sm text-slate-500">{{ user.email }}</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-2 gap-3">
        <div class="rounded-2xl border border-slate-100 bg-white p-4">
          <div class="text-xs text-slate-500">Role</div>
          <div class="mt-1 font-semibold text-slate-800">Standard</div>
        </div>
        <div class="rounded-2xl border border-slate-100 bg-white p-4">
          <div class="text-xs text-slate-500">Account</div>
          <div class="mt-1 font-semibold text-slate-800">Active</div>
        </div>
      </div>

      <div class="mt-4 rounded-2xl bg-mint-50 border border-mint-100 p-4">
        <div class="text-sm font-semibold text-mint-800">Tip</div>
        <p class="mt-1 text-sm text-mint-700">
          Add multiple devices to compare water conditions across locations.
        </p>
      </div>
    </div>


    <div class="rounded-3xl bg-white/75 backdrop-blur border border-white shadow-soft p-6 lg:col-span-2">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div>
          <div class="text-lg font-bold">Account details</div>
          <div class="text-sm text-slate-500">Basic info used for authentication and tracking.</div>
        </div>

        <div class="flex items-center gap-2">
          <a href="{{ url_for('logs.logs') }}"
             class="px-4 py-2 rounded-2xl text-sm font-semibold bg-aqua-100 text-aqua-700 border border-aqua-200 hover:bg-aqua-200 transition">
            View Logs
          </a>
          <a href="{{ url_for('status.status_page') }}"
             class="px-4 py-2 rounded-2xl text-sm font-semibold bg-slate-100 text-slate-700 border border-slate-200 hover:bg-slate-200 transition">
            System Status
          </a>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="rounded-2xl border border-slate-100 bg-white p-4">
          <div class="text-xs text-slate-500">Email</div>
          <div class="mt-1 font-semibold text-slate-900">{{ user.email }}</div>
          <div class="mt-2 text-xs text-slate-500">Used for login</div>
        </div>

        <div class="rounded-2xl border border-slate-100 bg-white p-4">
          <div class="text-xs text-slate-500">Member since</div>
          <div class="mt-1 font-semibold text-slate-900">
            {{ user.created_at if user.created_at else "—" }}
          </div>
          <div class="mt-2 text-xs text-slate-500">Account creation date</div>
        </div>
      </div>

     
      <div class="mt-6 rounded-2xl border border-slate-100 bg-white p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">Devices overview</div>
            <div class="text-xs text-slate-500">Your registered devices and quick actions.</div>
          </div>
          <a href="{{ url_for('dash.devices') }}"
             class="text-sm font-semibold text-aqua-700 hover:underline">
            Manage →
          </a>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
            <div class="text-xs text-slate-500">Total devices</div>
            <div id="deviceCount" class="mt-1 text-2xl font-extrabold text-slate-900">—</div>
          </div>
          <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4 md:col-span-2">
            <div class="text-xs text-slate-500">Latest telemetry</div>
            <div id="latestSummary" class="mt-1 font-semibold text-slate-900">—</div>
            <div id="latestTime" class="mt-1 text-xs text-slate-500">—</div>
          </div>
        </div>

        <div class="mt-4">
          <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Recent devices</div>
          <div id="deviceList" class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
         
          </div>
        </div>
      </div>

      
      <div class="mt-6 rounded-2xl bg-lavender-50 border border-lavender-100 p-4">
        <div class="text-sm font-semibold text-lavender-900">Security snapshot</div>
        <ul class="mt-2 text-sm text-lavender-900/80 list-disc pl-5 space-y-1">
          <li>HTTPS enabled for data in transit (browser ↔ Nginx ↔ Flask)</li>
          <li>Database connection secured with SSL (RDS)</li>
          <li>PubNub channels protected using Access Manager rules (per device)</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  
  function formatTs(ts) {
    try { return new Date(ts).toLocaleString(); } catch { return ts; }
  }

  
  async function loadProfileSnapshot() {
   
    try {
      const res = await fetch("/api/status");
      const j = await res.json();

      const latest = (j.last_telemetry_device && j.last_telemetry_ts)
        ? `${j.last_telemetry_device} • last reading received`
        : "No telemetry received yet";

      document.getElementById("latestSummary").textContent = latest;
      document.getElementById("latestTime").textContent =
        j.last_telemetry_ts ? `Updated: ${formatTs(j.last_telemetry_ts)}` : "—";
    } catch (e) {
      document.getElementById("latestSummary").textContent = "Unable to load status";
      document.getElementById("latestTime").textContent = "—";
    }

    
    try {
      const res = await fetch("/api/me/devices");
      if (!res.ok) throw new Error("no endpoint");
      const j = await res.json();

      const devices = j.data || [];
      document.getElementById("deviceCount").textContent = devices.length;

      const list = document.getElementById("deviceList");
      if (!devices.length) {
        list.innerHTML = `
          <div class="rounded-2xl border border-slate-100 bg-white p-4 text-sm text-slate-500">
            No devices added yet. Add one in <a class="text-aqua-700 font-semibold hover:underline" href="{{ url_for('dash.devices') }}">Devices</a>.
          </div>
        `;
        return;
      }

      list.innerHTML = devices.slice(0, 4).map(d => `
        <div class="rounded-2xl border border-slate-100 bg-white p-4">
          <div class="text-sm font-semibold text-slate-900">${d.nickname || d.device_id}</div>
          <div class="text-xs text-slate-500">${d.device_id}</div>
          <a class="mt-2 inline-block text-sm font-semibold text-aqua-700 hover:underline"
             href="{{ url_for('dash.dashboard') }}?device_id=${encodeURIComponent(d.device_id)}">
             Open dashboard →
          </a>
        </div>
      `).join("");
    } catch (e) {
      document.getElementById("deviceCount").textContent = "—";
      document.getElementById("deviceList").innerHTML = `
        <div class="rounded-2xl border border-slate-100 bg-white p-4 text-sm text-slate-500">
          Device list endpoint not enabled yet. You can still manage devices in
          <a class="text-aqua-700 font-semibold hover:underline" href="{{ url_for('dash.devices') }}">Devices</a>.
        </div>
      `;
    }
  }

  loadProfileSnapshot();
</script>
{% endblock %}
