{% extends "base.html" %}
{% block title %}Dashboard • ClearDrop{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>



<div class="flex flex-col gap-6">
  <!-- Header Card -->
  <div class="rounded-3xl bg-white/75 backdrop-blur border border-white shadow-soft p-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Live Dashboard</h1>
        <p class="text-slate-500 mt-1">Real-time water readings (PubNub → EC2 → RDS)</p>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-sm text-slate-500">Device</div>
        <select id="deviceSelect"
          class="px-4 py-2 rounded-2xl bg-white border border-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-aqua-300">
          {% for d in devices %}
            <option value="{{ d.device_id }}" {% if d.device_id == device_id %}selected{% endif %}>
              {{ d.nickname or d.device_id }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Status -->
    <div class="rounded-3xl bg-white/75 backdrop-blur border border-white shadow-soft p-6">
      <div class="text-sm text-slate-500">Status</div>
      <div id="statusBadge" class="mt-3 inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-semibold bg-mint-100 text-mint-700">
        <span class="h-2.5 w-2.5 rounded-full bg-mint-500"></span>
        Safe
      </div>

      <div class="mt-6 text-sm text-slate-500">Last update</div>
      <div id="lastUpdate" class="text-xl font-bold mt-1">—</div>
    </div>

    <!-- Temperature -->
    <div class="rounded-3xl bg-white/75 backdrop-blur border border-white shadow-soft p-6">
      <div class="text-sm text-slate-500">Temperature</div>
      <div class="mt-2 flex items-baseline gap-2">
        <div id="tempVal" class="text-3xl font-extrabold">—</div>
        <div class="text-slate-500">°C</div>
      </div>
      <div id="tempHint" class="mt-3 text-sm text-slate-500">—</div>
    </div>

    <!-- TDS -->
    <div class="rounded-3xl bg-white/75 backdrop-blur border border-white shadow-soft p-6">
      <div class="text-sm text-slate-500">TDS</div>
      <div class="mt-2 flex items-baseline gap-2">
        <div id="tdsVal" class="text-3xl font-extrabold">—</div>
        <div class="text-slate-500">ppm</div>
      </div>
      <div id="tdsHint" class="mt-3 text-sm text-slate-500">—</div>
    </div>
  </div>

  <!-- Chart -->
  <div class="rounded-3xl bg-white/75 backdrop-blur border border-white shadow-soft p-6">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <div>
        <div class="text-lg font-bold">Last 200 readings</div>
        <div class="text-sm text-slate-500">Auto-refresh every 5 seconds</div>
      </div>

      <button id="refreshBtn"
        class="px-4 py-2 rounded-2xl text-sm font-semibold text-white shadow-soft
               bg-gradient-to-r from-aqua-500 to-lavender-500 hover:opacity-95 transition">
        Refresh
      </button>
    </div>

   <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
  <div class="rounded-2xl bg-white p-3 border border-slate-100">
    <div class="text-sm font-semibold text-slate-700 mb-2">Temperature (°C) — last 50</div>
    <canvas id="tempChart" height="140"></canvas>
  </div>

  <div class="rounded-2xl bg-white p-3 border border-slate-100">
    <div class="text-sm font-semibold text-slate-700 mb-2">TDS (ppm) — last 50</div>
    <canvas id="tdsChart" height="140"></canvas>
  </div>
</div>

  </div>

  <!-- Actuator Controls -->
  <div class="rounded-3xl bg-white/75 backdrop-blur border border-white shadow-soft p-6">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <div>
        <div class="text-lg font-bold">Actuator Controls</div>
        <div class="text-sm text-slate-500">Send commands to your device buzzer via PubNub</div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnTestBuzz"
          class="px-4 py-2 rounded-2xl text-sm font-semibold bg-aqua-100 text-aqua-700 border border-aqua-200 hover:bg-aqua-200 transition">
          Test Buzzer
        </button>

        <button id="btnStopBuzz"
          class="px-4 py-2 rounded-2xl text-sm font-semibold bg-slate-100 text-slate-700 border border-slate-200 hover:bg-slate-200 transition">
          Stop
        </button>
      </div>
    </div>

    <div id="cmdStatus" class="mt-3 text-sm text-slate-500"></div>
  </div>
</div>

<script>
  const deviceSelect = document.getElementById("deviceSelect");
  const refreshBtn = document.getElementById("refreshBtn");

  const statusBadge = document.getElementById("statusBadge");
  const lastUpdate = document.getElementById("lastUpdate");
  const tempVal = document.getElementById("tempVal");
  const tdsVal = document.getElementById("tdsVal");
  const tempHint = document.getElementById("tempHint");
  const tdsHint = document.getElementById("tdsHint");

  const btnTestBuzz = document.getElementById("btnTestBuzz");
  const btnStopBuzz = document.getElementById("btnStopBuzz");
  const cmdStatus = document.getElementById("cmdStatus");

  function statusFrom(tempC, tdsPpm) {
    let level = "safe";
    if (tempC >= 42 || tdsPpm >= 450) level = "danger";
    else if (tempC >= 40 || tdsPpm >= 300) level = "warn";
    return level;
  }

  function setBadge(level) {
    statusBadge.className =
      "mt-3 inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-semibold";
    const dotClass = "h-2.5 w-2.5 rounded-full";

    if (level === "danger") {
      statusBadge.classList.add("bg-red-100", "text-red-700", "border", "border-red-200");
      statusBadge.innerHTML = `<span class="${dotClass} bg-red-500"></span> Danger`;
    } else if (level === "warn") {
      statusBadge.classList.add("bg-amber-100", "text-amber-800", "border", "border-amber-200");
      statusBadge.innerHTML = `<span class="${dotClass} bg-amber-500"></span> Warning`;
    } else {
      statusBadge.classList.add("bg-mint-100", "text-mint-700", "border", "border-mint-200");
      statusBadge.innerHTML = `<span class="${dotClass} bg-mint-500"></span> Safe`;
    }
  }

  // =========================
  // ✅ BAR + BAR CHARTS SETUP
  // (Requires: chart.js + luxon + chartjs-adapter-luxon scripts in <head>)
  // and canvas IDs: tempChart + tdsChart
  // =========================
  const tempCtx = document.getElementById("tempChart").getContext("2d");
  const tdsCtx = document.getElementById("tdsChart").getContext("2d");

  const timeScale = {
    type: "time",
    time: {
      tooltipFormat: "HH:mm:ss",
      displayFormats: { second: "HH:mm:ss", minute: "HH:mm" }
    },
    ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }
  };

  const baseBarOptions = {
    responsive: true,
    parsing: false, // using {x, y}
    plugins: {
      legend: { display: false },
      tooltip: { mode: "index", intersect: false }
    },
    scales: { x: timeScale }
  };

  const tempChart = new Chart(tempCtx, {
    type: "bar",
    data: { datasets: [{ label: "Temp (°C)", data: [] }] },
    options: {
      ...baseBarOptions,
      scales: {
        ...baseBarOptions.scales,
        y: { title: { display: true, text: "°C" }, suggestedMin: 20, suggestedMax: 50 }
      }
    }
  });

  const tdsChart = new Chart(tdsCtx, {
    type: "bar",
    data: { datasets: [{ label: "TDS (ppm)", data: [] }] },
    options: {
      ...baseBarOptions,
      scales: {
        ...baseBarOptions.scales,
        y: { title: { display: true, text: "ppm" }, suggestedMin: 0, suggestedMax: 600 }
      }
    }
  });

  async function fetchLatest(deviceId) {
    const res = await fetch(`/api/telemetry/latest?device_id=${encodeURIComponent(deviceId)}`);
    const json = await res.json();
    return json.data;
  }

  async function fetchHistory(deviceId, limit = 50) {
    const res = await fetch(
      `/api/telemetry/history?device_id=${encodeURIComponent(deviceId)}&limit=${limit}`
    );
    const json = await res.json();
    return json.data || [];
  }

  function formatTs(ts) {
    try {
      return new Date(ts).toLocaleString();
    } catch {
      return ts;
    }
  }

  async function refreshAll() {
    const deviceId = deviceSelect.value;

    const latest = await fetchLatest(deviceId);
    if (latest) {
      tempVal.textContent = Number(latest.temp_c).toFixed(1);
      tdsVal.textContent = latest.tds_ppm;
      lastUpdate.textContent = formatTs(latest.ts);

      const lvl = statusFrom(Number(latest.temp_c), Number(latest.tds_ppm));
      setBadge(lvl);

      tempHint.textContent =
        Number(latest.temp_c) >= 40 ? "High temperature — consider lowering" : "Temperature normal";
      tdsHint.textContent =
        Number(latest.tds_ppm) >= 300 ? "Higher mineral content detected" : "TDS normal";
    } else {
      tempVal.textContent = "—";
      tdsVal.textContent = "—";
      lastUpdate.textContent = "No data yet";
      setBadge("warn");
      tempHint.textContent = "Publish telemetry to see data";
      tdsHint.textContent = "Publish telemetry to see data";
    }

    // ✅ use fewer points for readable bars
    const history = await fetchHistory(deviceId, 50);

    const tempPoints = history.map(p => ({ x: new Date(p.ts), y: Number(p.temp_c) }));
    const tdsPoints = history.map(p => ({ x: new Date(p.ts), y: Number(p.tds_ppm) }));

    tempChart.data.datasets[0].data = tempPoints;
    tdsChart.data.datasets[0].data = tdsPoints;

    tempChart.update();
    tdsChart.update();
  }

  async function sendCmd(deviceId, body) {
    cmdStatus.textContent = "Sending…";
    const res = await fetch(`/api/device/${encodeURIComponent(deviceId)}/command`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const json = await res.json().catch(() => ({}));
    if (!res.ok) {
      cmdStatus.textContent = `Error: ${json.error || res.status}`;
      return;
    }
    cmdStatus.textContent = `Sent: ${body.cmd}`;
  }

  btnTestBuzz?.addEventListener("click", () => {
    const deviceId = deviceSelect.value;
    if (!deviceId) return;
    sendCmd(deviceId, { cmd: "buzz", pattern: "beep", freq_hz: 600, duration_ms: 700 });
  });

  btnStopBuzz?.addEventListener("click", () => {
    const deviceId = deviceSelect.value;
    if (!deviceId) return;
    sendCmd(deviceId, { cmd: "stop" });
  });

  deviceSelect.addEventListener("change", () => {
    const url = new URL(window.location.href);
    url.searchParams.set("device_id", deviceSelect.value);
    window.history.replaceState({}, "", url.toString());
    refreshAll();
  });

  refreshBtn.addEventListener("click", refreshAll);

  refreshAll();
  setInterval(refreshAll, 5000);
</script>

{% endblock %}
